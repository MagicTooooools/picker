---
title: 网络安全项目实施之踩坑记录
url: https://mp.weixin.qq.com/s/LNHNsTRGFFPx_H6bvQEJXg
source: Doonsec's feed
date: 2026-01-07
fetch_date: 2026-01-08T03:30:13.205212
---

# 网络安全项目实施之踩坑记录

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/icJLfUrOKojRxkJSQTwWOiakol5LBIe7wlLiczYIcRpZjMaK6wzDKbBTmypwxPfnicWI1IpPgwqj43sIghCJueV4iaw/0?wx_fmt=jpeg)

# 网络安全项目实施之踩坑记录

原创

小石同学

小石学习笔记

![]()

在小说阅读器中沉浸阅读

最近实施了一个学校的网络+安全的项目，这个项目最开始也是我和合作伙伴一起做的售前工作，后面因为种种原因实施工作又落到了我的头上。

简单介绍一下这个项目的具体情况，客户是一所中学，客户的需求是：

1. 核心机房的路由器、防火墙、核心交换机年限较久了，设备性能已经跟不上需求了，需要将核心机房的路由器、防火墙、核心交换机进行更换。
2. 部分楼层交换机是百兆的，部分是千兆的，客户计划统一更换。
3. 另外客户计划增加一套杀毒软件，给教师办公电脑使用。
4. 需要一个软件能够监管、查看全校网络情况。

客户最开始的需求就是这四个需求，这次采购还有其他设备，跟本次实施没有关系就不介绍了。

根据客户的需求，我们进行方案设计：

1. 考虑到客户是一所中学，所采购的设备是学校校园网的核心机房设备，对网络稳定运行的要求较高，因此我们对骨干链路设计为双链路冗余方案。
2. 客户同时使用DX和YD的网络，因此我们采用2台专用路由器作为整个网络的出口，通过NAT将客户内部服务映射到路由器，以实现互联网访问和内部用户上互联网；2台防火墙二层透明主备部署；2台核心做堆叠配置作为整个网络核心交换设备。
3. 杀毒软件、日志审计等安全设备接入核心交换机安全管理VLAN。

整个的设计如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/icJLfUrOKojRyeic43m9qkGiajEibqBAGy9NA4tSUsUxxzXnicquJvnuTI6UvJ0uv1ztQDTiaRVLrtQYzzm9KkIQFwUQ/640?wx_fmt=png&from=appmsg)

设备都陆续到货后，将设备都上架、上电、布线等一系列操作后，在12月份的某个晚上开始正式网络割接操作，一顿操作后，通过测试内部用户上网OK，互联网访问内部服务OK，然后就没有做其他测试了，就收拾东西睡觉了，以为不出意外没有问题了。

然而不出意外的意外来了，客户第二天白天早上就反馈网络有问题。

# 第一个问题

客户反馈有些用移动的手机访问不了映射到路由器的服务，用电信的可以访问，要求马上解决。

问题分析：接到反馈后马上赶到学校，通过自己实际测试，用移动卡流量确实无法访问服务，切换到电信流量可以访问，通过咔咔一顿分析，怀疑最有可能的是“数据包来回路径不一致”造成的此类现象，即当你用移动流量访问时，数据从移动侧进来，但是回包却从电信出口出去了，就会造成数据包来回路径不一致，从而导致区分运营商、移动访问不了、电信可以访问这种现象。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/icJLfUrOKojQD0hgt69KLTibL1vlCpaUz88YOtDgt24M6u0dFd6GOU0ic3v3j7Vb74bgibxRtYUickKXiahnB7mSYZgQ/640?wx_fmt=png&from=appmsg)

问题解决：这个问题涉及的就是一个源进源出的问题，按理说很好解决，一条配置就可以搞定，奈何网络设备厂家目前暂不支持这个，无奈只能通过在路由器加策略路由解决，所有到后端服务器的流量通通走电信侧出去，通过加策略路由后这个问题就解决了，没有在出现过。

# 第二个问题

客户反馈用学校的WiFi访问不了他们学校的网站（就是映射到路由器上的那个），用手机流量可以访问。

问题分析：接到问题后开启排查过程，发现回流策略是加了的，应该是没有问题的呀，后来经过咨询厂家是回流策略与策略路由同时存在的话，策略路由优先级高于回流策略的，即相当于内网访问www.test.com（域名只解析到了电信IP）路由器按理说应该执行回流策略进行响应，但是前面添加的策略路由优先级高于回流策略，导致数据包被路由器扔到公网上去了![](https://res.wx.qq.com/t/wx_fed/we-emoji/res/assets/newemoji/2_05.png)

问题解决：经过和厂家的沟通，决定对网络架构进行改造，2台出口路由器取消堆叠，分开部署，一台接移动运营商，另外一台接电线运营商，策略路由在核心交换机做，与服务器交互的流量都走电信侧出。改动后的架构是这样的：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/icJLfUrOKojRxkJSQTwWOiakol5LBIe7wlsp8iaFWML08U5zkyJdyr1QqbmjTPqepf7HyiaVg0cxf7ql1M31foyD3A/640?wx_fmt=png&from=appmsg)

这样改动后使用WiFi通过域名可以访问映射到路由器的服务，所有与服务器交互的流量根据策略路由都走电信侧也不会出现数据包来回路径不一致的问题。

虽然与最开始设计的双链路冗余有点背道而驰，但是目前也只能这样解决，据厂家反馈后续源进源出功能已在开发中，后边路由器支持源进源出后这两个问题都会解决，实际上第二个问题可以看做是由第一个问题引起的。

这就是在这个项目交付中所遇到的问题和解决办法，写这篇文章也是对这个项目的交付做一个总结与回顾。

预览时标签不可点

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/icJLfUrOKojQ3l96TfOS0sgD4ERSJOMSfkfz3SuXv7357q72NSNPkPOhby4rw6Pz17t336gHGQ8VeWOeos6Crbw/0?wx_fmt=png)

小石学习笔记

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/icJLfUrOKojQ3l96TfOS0sgD4ERSJOMSfkfz3SuXv7357q72NSNPkPOhby4rw6Pz17t336gHGQ8VeWOeos6Crbw/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过